<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>
        <template id="manifest_json" name="PWA Manifest Assets">
            <link id="xpanel_manifest" rel="manifest" href="/xpanel_erp/static/manifest.json?v=1.0.2"/>
            <link id="xpanel_icon" rel="icon" type="image/png" href="/xpanel_erp/static/src/img/xpanelerp.png?v=1.0.2"/>
            <link id="xpanel_shortcut_icon" rel="shortcut icon" type="image/png" href="/xpanel_erp/static/src/img/xpanelerp.png?v=1.0.2"/>
            <link id="xpanel_apple_icon" rel="apple-touch-icon" href="/xpanel_erp/static/src/img/xpanelerp.png?v=1.0.2"/>
            
            <meta name="apple-mobile-web-app-capable" content="yes"/>
            <meta name="mobile-web-app-capable" content="yes"/>
            <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
            <meta name="apple-mobile-web-app-title" content="XpanelERP"/>
            <meta name="application-name" content="XpanelERP"/>
            <meta name="theme-color" content="#000000"/>

            <script type="text/javascript">
                <![CDATA[
                (function() {
                    function cleanOdooBranding() {
                        document.querySelectorAll('link[rel="manifest"]').forEach(l => {
                            if (l.id !== 'xpanel_manifest') l.remove();
                        });

                        document.querySelectorAll('link[rel*="icon"], link[rel="apple-touch-icon"]').forEach(i => {
                            if (!i.id.startsWith('xpanel_')) {
                                i.remove();
                            }
                        });

                        if (document.title.toLowerCase().includes('odoo')) {
                            document.title = document.title.replace(/Odoo/gi, 'XpanelERP');
                        } else if (!document.title.includes('XpanelERP')) {
                            document.title = 'XpanelERP | ' + document.title;
                        }

                        ['apple-mobile-web-app-title', 'application-name'].forEach(name => {
                            let meta = document.querySelector('meta[name="' + name + '"]');
                            if (!meta) {
                                meta = document.createElement('meta');
                                meta.name = name;
                                document.head.appendChild(meta);
                            }
                            if (meta.getAttribute('content') !== 'XpanelERP') {
                                meta.setAttribute('content', 'XpanelERP');
                            }
                        });

                        const theme = document.querySelector('meta[name="theme-color"]');
                        if (theme && theme.getAttribute('content') !== '#000000') {
                            theme.setAttribute('content', '#000000');
                        }

                        const websiteFavicon = document.querySelector('link[href*="favicon.ico"]');
                        if (websiteFavicon && !websiteFavicon.id.startsWith('xpanel_')) {
                            websiteFavicon.remove();
                        }
                    }

                    cleanOdooBranding();

                    const observer = new MutationObserver(cleanOdooBranding);
                    observer.observe(document.head, { childList: true, subtree: true });

                    window.addEventListener('load', cleanOdooBranding);
                    window.addEventListener('DOMContentLoaded', cleanOdooBranding);
                })();
                ]]>
            </script>
        </template>

        <template id="service_worker_registration" name="PWA Service Worker">
            <script type="text/javascript">
                <![CDATA[
                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', function() {
                        navigator.serviceWorker.getRegistrations().then(function(registrations) {
                            for(let registration of registrations) {
                                if (!registration.active || !registration.active.scriptURL.includes('xpanel_erp')) {
                                    registration.unregister();
                                }
                            }
                        });
                        navigator.serviceWorker.register('/xpanel_erp/static/sw.js?v=1.0.3')
                            .then(reg => console.log('XpanelERP: SW registered'))
                            .catch(err => console.log('XpanelERP: SW failed', err));
                    });
                }
                ]]>
            </script>
        </template>

        <template id="layout_inherit_pwa" inherit_id="web.layout">
            <xpath expr="//head/*[1]" position="before">
                <t t-call="xpanel_erp.manifest_json"/>
                <t t-call="xpanel_erp.service_worker_registration"/>
            </xpath>
        </template>

        <template id="xpanel_footer_template" name="XpanelERP Footer Navigation">
            <div id="xpanel_footer" class="xpanel-footer" style="display: none;">
                <div class="xpanel-footer-container">
                    <button class="xpanel-footer-btn" data-action="console">
                        <svg class="xpanel-footer-icon" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                            <rect x="2" y="2" width="9" height="9" rx="1"></rect>
                            <rect x="14" y="2" width="9" height="9" rx="1"></rect>
                            <rect x="14" y="14" width="9" height="9" rx="1"></rect>
                            <rect x="2" y="14" width="9" height="9" rx="1"></rect>
                        </svg>
                        <span class="xpanel-footer-label">Console</span>
                    </button>
                    
                    <button class="xpanel-footer-btn" data-action="worklogs">
                        <svg class="xpanel-footer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <circle cx="12" cy="12" r="10"></circle>
                            <polyline points="12 6 12 12 16 14"></polyline>
                        </svg>
                        <span class="xpanel-footer-label">Worklogs</span>
                    </button>
                    
                    <button class="xpanel-footer-btn" data-action="assistant">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" class="xpanel-footer-icon">
                            <path fill="currentColor" stroke="currentColor" stroke-linejoin="round" stroke-width="1.5" d="m10 7l-.516 1.394c-.676 1.828-1.014 2.742-1.681 3.409s-1.581 1.005-3.409 1.681L3 14l1.394.516c1.828.676 2.742 1.015 3.409 1.681s1.005 1.581 1.681 3.409L10 21l.516-1.394c.676-1.828 1.015-2.742 1.681-3.409s1.581-1.005 3.409-1.681L17 14l-1.394-.516c-1.828-.676-2.742-1.014-3.409-1.681s-1.005-1.581-1.681-3.409zm8-4l-.221.597c-.29.784-.435 1.176-.72 1.461c-.286.286-.678.431-1.462.72L15 6l.598.221c.783.29 1.175.435 1.46.72c.286.286.431.678.72 1.462L18 9l.221-.597c.29-.784.435-1.176.72-1.461c.286-.286.678-.431 1.462-.72L21 6l-.598-.221c-.783-.29-1.175-.435-1.46-.72c-.286-.286-.431-.678-.72-1.462z"></path>
                        </svg>
                        <span class="xpanel-footer-label">Assistant</span>
                    </button>
                    
                    <button class="xpanel-footer-btn" data-action="analytics">
                        <svg class="xpanel-footer-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <line x1="18" y1="20" x2="18" y2="10"></line>
                            <line x1="12" y1="20" x2="12" y2="4"></line>
                            <line x1="6" y1="20" x2="6" y2="14"></line>
                        </svg>
                        <span class="xpanel-footer-label">Analytics</span>
                    </button>
                    
                    <button class="xpanel-footer-btn" data-action="back">
                        <svg class="xpanel-footer-icon" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 1024 1024">
                            <path fill="currentColor" d="M609.4 149.4L277.8 489.6a32 32 0 0 0 0 44.7l331.6 340.3a29 29 0 0 0 41.7 0a30.6 30.6 0 0 0 0-42.7l-311.8-320L651 192.1a30.6 30.6 0 0 0 0-42.7a29 29 0 0 0-41.7 0"></path>
                        </svg>
                        <span class="xpanel-footer-label">Back</span>
                    </button>
                </div>
            </div>
        </template>

        <template id="website_layout_inherit_pwa" inherit_id="website.layout">
            <xpath expr="//head/*[1]" position="before">
                <t t-call="xpanel_erp.manifest_json"/>
                <t t-call="xpanel_erp.service_worker_registration"/>
            </xpath>
        </template>

        <template id="webclient_bootstrap_inherit" inherit_id="web.webclient_bootstrap">
            <xpath expr="." position="inside">
                <t t-call="xpanel_erp.xpanel_footer_template" groups="base.group_user"/>
            </xpath>
        </template>
    </data>
</odoo>
